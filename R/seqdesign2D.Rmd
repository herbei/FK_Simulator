---
title: "Seq design 2D"
author: "Pierre Barbillon"
date: "07/05/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,echo=FALSE,cache = TRUE)
#load("Designseq2D.Rdata")
#load("Designseq2Dbis.Rdata")
#load("designseq2D10paths2.Rdata")
#load("designs2Ds.Rdata")
#load("designs2DnewversionHetGP.Rdata")
#load("designs2DnewversionHetGPless.Rdata")
load("designs2DnewversionHetGPlesspath.Rdata")
library(ggplot2)
library(colorRamps)
library(hetGP)
designseq = as.data.frame(cbind(mod$X0,mod$mult))
names(designseq) = c("long","lat","rep")
gridHom$psd = sqrt(gridHom$nug+gridHom$varmean)
gridhet$psd = sqrt(gridhet$nug+gridhet$varmean)
```

```{r unnormalize}
gridHom$mean = gridHom$mean * sqrt(Zv) + Zm
gridHom$varmean = gridHom$varmean * Zv
gridHom$psd = gridHom$psd * sqrt(Zv)
gridHom$nug = gridHom$nug * Zv
gridhet$mean = gridhet$mean * sqrt(Zv) + Zm
gridhet$varmean = gridhet$varmean * Zv
gridhet$psd = gridhet$psd * sqrt(Zv)
gridhet$nug = gridhet$nug * Zv
gridhetseq$mean = gridhetseq$mean * sqrt(Zv) + Zm
gridhetseq$varmean = gridhetseq$varmean * Zv
gridhetseq$psd = gridhetseq$psd * sqrt(Zv)
gridhetseq$nug = gridhetseq$nug * Zv
```




Design in 2D (longitude and latitude for site locations). The diffusion parameters are fixed to $K_x=700$ and $K_y=200$.

Sizes of the designs:

  - for HomGP and HetGP: `r nrow(Ghet$X0)` unique locations with `r Ghet$mult[1]` replications each.
  - for seqHetGP: sequential design built as a initial design with `r nrow(Ghet$X0)` unique locations with `r Ghet$mult[1]/2` replications each and $500$ added runs. The number of replications per unique location is `r (mod$mult)`.

## Plots for homGP

2D
```{r plot homgp}
ggplot(gridHom, aes(long, lat)) + geom_raster(aes(fill = mean), interpolate = TRUE) + scale_fill_gradientn(colours=matlab.like(10),limits=c(min(gridHom$mean,gridhet$mean),max(gridHom$mean,gridhet$mean)))
ggplot(gridHom, aes(long, lat)) + geom_raster(aes(fill = varmean), interpolate = TRUE)+ scale_fill_gradientn(colours=matlab.like(10),limits=c(min(gridHom$varmean,gridhet$varmean),max(gridHom$varmean,gridhet$varmean)))
```

Slice with middle location for longitude

```{r slice homgp}
islice = which(gridHom$long==.5)
ggplot(gridHom[islice,],aes(x=lat,y=mean)) +theme_bw()+
  geom_ribbon(aes(ymin = mean-2*sqrt(varmean+nug), ymax = mean+2*sqrt(varmean+nug),fill="prediction"))+geom_ribbon(aes(ymin = mean-2*sqrt(varmean), ymax = mean+2*sqrt(varmean),fill="confidence"))+scale_fill_manual("",values=c("steelblue","lightpink"))+geom_line(aes(x=lat,y=mean,colour="mean"))+scale_colour_manual("",values="black")
```


Plot for nugget + predictive mean variance (in standard deviation)


```{r psdhom}
ggplot(gridHom, aes(long, lat)) + geom_raster(aes(fill = psd), interpolate = TRUE)+ scale_fill_gradientn(colours=matlab.like(10),limits=c(min(gridHom$psd,gridhet$psd),max(gridHom$psd,gridhet$psd)))
```






## Plots for hetGP

2D
```{r plot hetgp}
ggplot(gridhet, aes(long, lat)) + geom_raster(aes(fill = mean), interpolate = TRUE) +scale_fill_gradientn(colours=matlab.like(10),limits=c(min(gridHom$mean,gridhet$mean),max(gridHom$mean,gridhet$mean)))
ggplot(gridhet, aes(long, lat)) + geom_raster(aes(fill = varmean), interpolate = TRUE) + scale_fill_gradientn(colours=matlab.like(10),limits=c(min(gridHom$varmean,gridhet$varmean),max(gridHom$varmean,gridhet$varmean)))
ggplot(gridhet, aes(long, lat)) + geom_raster(aes(fill = nug), interpolate = TRUE) +scale_fill_gradientn(colours=matlab.like(10))
```


Slice with middle location for longitude

```{r slice hetgp}
ggplot(gridhet[islice,],aes(x=lat,y=mean)) +theme_bw()+
  geom_ribbon(aes(ymin = mean-2*sqrt(varmean+nug), ymax = mean+2*sqrt(varmean+nug),fill="prediction"))+geom_ribbon(aes(ymin = mean-2*sqrt(varmean), ymax = mean+2*sqrt(varmean),fill="confidence"))+scale_fill_manual("",values=c("steelblue","lightpink"))+geom_line(aes(x=lat,y=mean,colour="mean"))+scale_colour_manual("",values="black")
```


Plot for nugget + predictive mean variance (in standard deviation)

```{r psdhet}
ggplot(gridhet, aes(long, lat)) + geom_raster(aes(fill = psd), interpolate = TRUE)+ scale_fill_gradientn(colours=matlab.like(10),limits=c(min(gridHom$psd,gridhet$psd),max(gridHom$psd,gridhet$psd)))
```

## After adding sequentially runs for hetGP

Number of added runs: 500


Estimated nugget
```{r seq design nug}
ggplot(gridhetseq, aes(long, lat)) + geom_raster(aes(fill = nug), interpolate = TRUE) + scale_fill_gradientn(colours=matlab.like(10))+geom_point(data=designseq,aes(x=long,y=lat,colour=rep))+scale_color_gradient(low="grey", high="black")
```

New predictive mean

```{r seq design mean}
ggplot(gridhetseq, aes(long, lat)) + geom_raster(aes(fill = mean), interpolate = TRUE) + scale_fill_gradientn(colours=matlab.like(10))+geom_point(data=designseq,aes(x=long,y=lat,colour=rep))+scale_color_gradient(low="grey", high="black")
```


m


Plot for nugget + predictive mean variance (in standard deviation)

```{r psdhetseq}
ggplot(gridhetseq, aes(long, lat)) + geom_raster(aes(fill = psd), interpolate = TRUE)+ scale_fill_gradientn(colours=matlab.like(10))+geom_point(data=designseq,aes(x=long,y=lat,colour=rep))+scale_color_gradient(low="grey", high="black")
```


```{r psdhetseq withnumbers}
ggplot(gridhetseq, aes(long, lat)) + geom_raster(aes(fill = psd), interpolate = TRUE)+ scale_fill_gradientn(colours=matlab.like(10))+geom_text(data=designseq,aes(x=long,y=lat,label=rep))
```


Predictive mean variance after adding the points sequentially

```{r varmean seq}
ggplot(gridhetseq, aes(long, lat)) + geom_raster(aes(fill = varmean ), interpolate = TRUE)+ scale_fill_gradientn(colours=matlab.like(10))+geom_point(data=designseq,aes(x=long,y=lat,colour=rep))+scale_color_gradient(low="grey", high="black")
```


predictive mean variance before adding the points sequentially
```{r varmean seq before adding}
ggplot(gridhet, aes(long, lat)) + geom_raster(aes(fill = varmean ), interpolate = TRUE)+ scale_fill_gradientn(colours=matlab.like(10))+geom_point(data=designseq,aes(x=long,y=lat,colour=rep))+scale_color_gradient(low="grey", high="black")
```



## comparison for prediction

```{r load data test}
load("testdesign2D.Rdata")
#vmNorm = (vm-Zm)/sqrt(Zv)
library(hetGP)
#Hom GP
predhom = predict(x = testdesign, object = Ghom)
#Het GP
predhet = predict(x = testdesign, object = Ghet)
#Het GP seq
predHetseq = predict(x = testdesign, object = mod)
# RMSE
msehom = mean(((predhom$mean-Ztest.true))^2)
msehet = mean(((predhet$mean-Ztest.true))^2)
msehetseq = mean(((predHetseq$mean-Ztest.true))^2)
# scores
schom = mean(-(Ztest.true-predhom$mean)^2/(predhom$sd2) -log(predhom$sd2))
schet = mean(-(Ztest.true-predhet$mean)^2/(predhet$sd2) -log(predhet$sd2))
schetseq = mean(-(Ztest.true-predHetseq$mean)^2/(predHetseq$sd2) -log(predHetseq$sd2))
# scores 2
schom2 = mean(-(Ztest-predhom$mean)^2/(predhom$sd2+predhom$nugs) -log(predhom$sd2+predhom$nugs))
schet2 = mean(-(Ztest-predhet$mean)^2/(predhet$sd2+predhet$nugs) -log(predhet$sd2+predhet$nugs))
schetseq2 = mean(-(Ztest-predHetseq$mean)^2/(predHetseq$sd2+predHetseq$nugs) -log(predHetseq$sd2+predHetseq$nugs))
```


```{r results}
c(rmsehom=msehom,rmsehet=msehet,rmsehetse=msehetseq)
c(scorehom=schom,scorehet=schet,scorehetse=schetseq)
c(scorehom=schom2,scorehet=schet2,scorehetse=schetseq2)
```


